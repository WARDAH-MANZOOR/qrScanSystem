// schema.prisma

datasource db {
  provider = "postgresql" // Assuming PostgreSQL
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["typedSql"]
}

enum TransactionStatus {
  completed
  pending
  failed
}

enum TransactionType {
  wallet
  card
  bank
}

model Group {
  id          Int               @id @default(autoincrement())
  name        String            @unique
  permissions GroupPermission[]
  users       UserGroup[]
}

model Permission {
  id     Int               @id @default(autoincrement())
  name   String            @unique
  groups GroupPermission[]
}

model UserGroup {
  userId     Int
  groupId    Int
  user       User     @relation(fields: [userId], references: [id])
  group      Group    @relation(fields: [groupId], references: [id])
  merchantId Int? // merchant association
  merchant   Merchant? @relation(fields: [merchantId], references: [merchant_id])

  @@id([userId, groupId])
}

model GroupPermission {
  groupId      Int
  permissionId Int
  group        Group      @relation(fields: [groupId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([groupId, permissionId])
}

model Merchant {
  merchant_id    Int         @id @default(autoincrement())
  full_name      String
  phone_number   String
  company_name   String
  company_url    String?
  city           String
  payment_volume Decimal?    @db.Decimal(10, 2)
  user_id        Int
  commission     Decimal?    @db.Decimal(10,2)
  user           User        @relation("Owner", fields: [user_id], references: [id]) // Relation to owner User
  user_groups    UserGroup[] // Associate UserGroups with Merchant
  users          User[]      @relation("AssociatedUsers") // List of associated Users for this Merchant
}

model User {
  id          Int           @id @default(autoincrement())
  username    String
  email       String        @unique
  password    String
  groups      UserGroup[]
  merchant_id Int?
  merchant    Merchant?      @relation("AssociatedUsers", fields: [merchant_id], references: [merchant_id])

  ownerOfMerchants Merchant[] @relation("Owner") // Opposite relation for owner User
  Transaction Transaction[]

  @@unique([email, merchant_id]) // Ensure unique combination of email and merchant
}

model Transaction {
  transaction_id   String               @id @unique
  date_time        DateTime
  original_amount  Decimal?          @db.Decimal(10, 2)
  status           TransactionStatus
  type             TransactionType
  response_message String?
  settlement       Boolean           @default(false)
  settled_amount   Decimal?          @db.Decimal(10, 2)
  merchant_id      Int
  merchant         User              @relation(fields: [merchant_id], references: [id])
  AdditionalInfo   AdditionalInfo?   @relation(fields: [additionalInfoId], references: [id])
  additionalInfoId Int?
  Provider         Provider?         @relation(fields: [providerId], references: [id])
  providerId       Int?
  disbursed        Boolean           @default(false)
}

model AdditionalInfo {
  id                Int           @id @default(autoincrement())
  bank_id           String? // Bank ID for JazzCash
  bill_reference    String? // Bill reference number
  retrieval_ref     String? // Retrieval reference number
  sub_merchant_id   String? // Optional sub-merchant ID
  settlement_expiry String? // Optional settlement expiry time
  custom_field_1    String? // Optional custom field
  custom_field_2    String?
  custom_field_3    String?
  custom_field_4    String?
  custom_field_5    String?
  transactions      Transaction[] // One-to-many relation to transactions
}

model Provider {
  id           Int           @id @default(autoincrement())
  name         String // e.g., JazzCash, Easypaisa
  txn_type     String? // Transaction type (MWALLET, etc.)
  version      String? // API version
  transactions Transaction[] // One-to-many relationship with transactions
  @@unique([name, txn_type, version])  // Composite unique index
}

model ScheduledTask {
  id            Int       @id @default(autoincrement())
  transactionId String?
  status        String    @db.VarChar(50)
  scheduledAt   DateTime? @db.Timestamptz
  executedAt    DateTime? @db.Timestamptz
}

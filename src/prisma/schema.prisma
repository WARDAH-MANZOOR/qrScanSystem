datasource db {
  provider = "postgresql" // Assuming PostgreSQL
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["typedSql"]
}

enum TransactionStatus {
  completed
  pending
  failed
}

enum TransactionType {
  wallet
  card
  bank
}

enum ProviderEnum {
  JAZZCASH
  EASYPAISA
  // Add other providers as needed
}

model Group {
  id          Int               @id @default(autoincrement())
  name        String            @unique
  permissions GroupPermission[]
  users       UserGroup[]
}

model Permission {
  id     Int               @id @default(autoincrement())
  name   String            @unique
  groups GroupPermission[]
}

model UserGroup {
  userId     Int
  groupId    Int
  user       User      @relation(fields: [userId], references: [id])
  group      Group     @relation(fields: [groupId], references: [id])
  merchantId Int? // merchant association
  merchant   Merchant? @relation(fields: [merchantId], references: [merchant_id])

  @@id([userId, groupId])
}

model GroupPermission {
  groupId      Int
  permissionId Int
  group        Group      @relation(fields: [groupId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([groupId, permissionId])
}

model Merchant {
  uid            String?     @default(uuid())
  merchant_id    Int         @id @default(autoincrement())
  full_name      String
  phone_number   String
  company_name   String
  company_url    String?
  city           String
  payment_volume Decimal?    @db.Decimal(10, 2)
  user_id        Int
  user           User        @relation("Owner", fields: [user_id], references: [id])
  user_groups    UserGroup[] // Associate UserGroups with Merchant
  users          User[]      @relation("AssociatedUsers") // List of associated Users for this Merchant

  // New relation to MerchantCommission
  commissions                MerchantFinancialTerms[]
  MerchantProviderCredential MerchantProviderCredential[]
  SettlementReport           SettlementReport[]
}

model MerchantProviderCredential {
  id          Int      @id @default(autoincrement())
  merchant_id Int
  merchant    Merchant @relation(fields: [merchant_id], references: [merchant_id])

  provider ProviderEnum // Enum for provider

  // Credential Fields
  merchantOrStoreId   String
  passwordOrHashKey   String
  returnOrPostBackUrl String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchant_id, provider])
}

model MerchantFinancialTerms {
  id          Int      @id @default(autoincrement())
  merchant_id Int      @unique
  merchant    Merchant @relation(fields: [merchant_id], references: [merchant_id])

  commissionRate             Decimal @db.Decimal(10, 2)
  commissionWithHoldingTax   Decimal @db.Decimal(10, 2)
  commissionGST              Decimal @db.Decimal(10, 2)
  disbursementRate           Decimal @db.Decimal(10, 2)
  disbursementWithHoldingTax Decimal @db.Decimal(10, 2)
  disbursementGST            Decimal @db.Decimal(10, 2)
  settlementDuration         Int // Number of days for settlement

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchant_id])
}

model User {
  id          Int         @id @default(autoincrement())
  username    String
  email       String      @unique
  password    String
  groups      UserGroup[]
  merchant_id Int?
  merchant    Merchant?   @relation("AssociatedUsers", fields: [merchant_id], references: [merchant_id])

  ownerOfMerchants     Merchant[]    @relation("Owner") // Opposite relation for owner User
  // Transactions as Merchant
  merchantTransactions Transaction[] @relation("MerchantTransactions")

  // Transactions as Customer
  customerTransactions Transaction[] @relation("CustomerTransactions")

  @@unique([email, merchant_id]) // Ensure unique combination of email and merchant
}

model Transaction {
  transaction_id   String            @id @unique
  date_time        DateTime
  original_amount  Decimal?          @db.Decimal(10, 2)
  status           TransactionStatus
  type             TransactionType
  response_message String?
  settlement       Boolean           @default(false)
  settled_amount   Decimal?          @db.Decimal(10, 2)
  balance          Decimal           @default(0) @db.Decimal(10, 2)

  merchant_id Int
  merchant    User @relation("MerchantTransactions", fields: [merchant_id], references: [id])

  customer_id Int?
  customer    User? @relation("CustomerTransactions", fields: [customer_id], references: [id])

  additionalInfoId Int? @unique
  AdditionalInfo   AdditionalInfo? @relation(fields: [additionalInfoId], references: [id])

  providerId Int?
  Provider   Provider? @relation(fields: [providerId], references: [id])
  scheduledTasks   ScheduledTask[]
}

model AdditionalInfo {
  id                Int           @id @default(autoincrement())
  bank_id           String? // Bank ID for JazzCash
  bill_reference    String? // Bill reference number
  retrieval_ref     String? // Retrieval reference number
  sub_merchant_id   String? // Optional sub-merchant ID
  settlement_expiry String? // Optional settlement expiry time
  custom_field_1    String? // Optional custom field
  custom_field_2    String?
  custom_field_3    String?
  custom_field_4    String?
  custom_field_5    String?
  transaction       Transaction? // One-to-many relation to transactions
}

model Provider {
  id           Int           @id @default(autoincrement())
  name         String // e.g., JazzCash, Easypaisa
  txn_type     String? // Transaction type (MWALLET, etc.)
  version      String? // API version
  transactions Transaction[] // One-to-many relationship with transactions

  @@unique([name, txn_type, version]) // Composite unique index
}

model ScheduledTask {
  id            Int       @id @default(autoincrement())
  transactionId String    @unique
  status        String    @db.VarChar(50)
  scheduledAt   DateTime? @db.Timestamptz
  executedAt    DateTime? @db.Timestamptz
  transaction   Transaction  @relation(fields: [transactionId], references: [transaction_id])
}

model SettlementReport {
  id                Int      @id @default(autoincrement())
  merchant_id       Int
  merchant          Merchant @relation(fields: [merchant_id], references: [merchant_id])
  settlementDate    DateTime
  transactionCount  Int
  transactionAmount Decimal  @db.Decimal(10, 2)
  commission        Decimal  @db.Decimal(10, 2)
  gst               Decimal  @db.Decimal(10, 2)
  withholdingTax    Decimal  @db.Decimal(10, 2)
  merchantAmount    Decimal  @db.Decimal(10, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([merchant_id, settlementDate]) // Prevent duplicate settlements for the same merchant and date
}

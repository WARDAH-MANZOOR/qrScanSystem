datasource db {
  provider = "postgresql" // Assuming PostgreSQL
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["typedSql"]
}

enum TransactionStatus {
  completed
  pending
  failed
}

enum TransactionType {
  wallet
  card
  bank
}

enum ProviderEnum {
  JAZZCASH
  EASYPAISA
  // Add other providers as needed
}

model Group {
  id          Int               @id @default(autoincrement())
  name        String            @unique
  permissions GroupPermission[]
  users       UserGroup[]
}

model Permission {
  id     Int               @id @default(autoincrement())
  name   String            @unique
  groups GroupPermission[]
}

model UserGroup {
  id         Int       @id @default(autoincrement())
  userId     Int
  groupId    Int
  user       User      @relation(fields: [userId], references: [id])
  group      Group     @relation(fields: [groupId], references: [id])
  merchantId Int? // merchant association
  merchant   Merchant? @relation(fields: [merchantId], references: [merchant_id])
}

model GroupPermission {
  groupId      Int
  permissionId Int
  group        Group      @relation(fields: [groupId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([groupId, permissionId])
}

model Merchant {
  uid            String?     @default(uuid())
  merchant_id    Int         @id @default(autoincrement())
  full_name      String
  phone_number   String
  company_name   String
  company_url    String?
  city           String
  payment_volume Decimal?
  user_id        Int
  webhook_url    String?
  user_groups    UserGroup[] // Associate UserGroups with Merchant

  // New relation to MerchantCommission
  commissions                MerchantFinancialTerms[]
  MerchantProviderCredential MerchantProviderCredential[]

  jazzCashMerchantId Int?
  jazzCashMerchant   JazzCashMerchant?  @relation(fields: [jazzCashMerchantId], references: [id])
  SettlementReport   SettlementReport[]

  easyPaisaMerchantId Int?
  easyPaisaMerchant   EasyPaisaMerchant? @relation(fields: [easyPaisaMerchantId], references: [id])
  SwichMerchant       SwichMerchant?     @relation(fields: [swichMerchantId], references: [id])
  swichMerchantId     Int?
}

model MerchantProviderCredential {
  id          Int      @id @default(autoincrement())
  merchant_id Int
  merchant    Merchant @relation(fields: [merchant_id], references: [merchant_id])

  provider ProviderEnum // Enum for provider

  // Credential Fields
  merchantOrStoreId   String
  passwordOrHashKey   String
  returnOrPostBackUrl String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchant_id, provider])
}

model MerchantFinancialTerms {
  id          Int      @id @default(autoincrement())
  merchant_id Int      @unique
  merchant    Merchant @relation(fields: [merchant_id], references: [merchant_id])

  commissionRate             Decimal
  commissionWithHoldingTax   Decimal
  commissionGST              Decimal
  disbursementRate           Decimal
  disbursementWithHoldingTax Decimal
  disbursementGST            Decimal
  settlementDuration         Int // Number of days for settlement

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchant_id])
}

model User {
  id       Int         @id @default(autoincrement())
  username String
  email    String      @unique
  password String
  groups   UserGroup[]

  // Transactions as Merchant
  merchantTransactions Transaction[] @relation("MerchantTransactions")

  // Transactions as Customer
  customerTransactions Transaction[] @relation("CustomerTransactions")

  @@index([email])
}

model Transaction {
  transaction_id   String            @id @unique
  date_time        DateTime
  original_amount  Decimal?
  status           TransactionStatus
  type             TransactionType
  response_message String?
  settlement       Boolean           @default(false)
  settled_amount   Decimal?
  balance          Decimal           @default(0)

  merchant_id Int
  merchant    User @relation("MerchantTransactions", fields: [merchant_id], references: [id])

  customer_id Int?
  customer    User? @relation("CustomerTransactions", fields: [customer_id], references: [id])

  additionalInfoId Int?            @unique
  AdditionalInfo   AdditionalInfo? @relation(fields: [additionalInfoId], references: [id])

  providerId     Int?
  Provider       Provider?       @relation(fields: [providerId], references: [id])
  scheduledTasks ScheduledTask[]
}

model AdditionalInfo {
  id                Int          @id @default(autoincrement())
  bank_id           String? // Bank ID for JazzCash
  bill_reference    String? // Bill reference number
  retrieval_ref     String? // Retrieval reference number
  sub_merchant_id   String? // Optional sub-merchant ID
  settlement_expiry String? // Optional settlement expiry time
  custom_field_1    String? // Optional custom field
  custom_field_2    String?
  custom_field_3    String?
  custom_field_4    String?
  custom_field_5    String?
  transaction       Transaction? // One-to-many relation to transactions
}

model Provider {
  id           Int           @id @default(autoincrement())
  name         String // e.g., JazzCash, Easypaisa
  txn_type     String? // Transaction type (MWALLET, etc.)
  version      String? // API version
  transactions Transaction[] // One-to-many relationship with transactions

  @@unique([name, txn_type, version]) // Composite unique index
}

model ScheduledTask {
  id            Int         @id @default(autoincrement())
  transactionId String      @unique
  status        String      @db.VarChar(50)
  scheduledAt   DateTime?   @db.Timestamptz
  executedAt    DateTime?   @db.Timestamptz
  transaction   Transaction @relation(fields: [transactionId], references: [transaction_id])
}

model SettlementReport {
  id                Int      @id @default(autoincrement())
  merchant_id       Int
  merchant          Merchant @relation(fields: [merchant_id], references: [merchant_id])
  settlementDate    DateTime
  transactionCount  Int
  transactionAmount Decimal
  commission        Decimal
  gst               Decimal
  withholdingTax    Decimal
  merchantAmount    Decimal
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([merchant_id, settlementDate]) // Prevent duplicate settlements for the same merchant and date
}

model JazzCashMerchant {
  id             Int        @id @default(autoincrement())
  jazzMerchantId String
  password       String
  returnUrl      String
  integritySalt  String
  metadata       Json       @default("{}")
  merchantId     Int
  merchant       Merchant[] // One-to-many relationship with Merchant
}

model EasyPaisaMerchant {
  id            Int        @id @default(autoincrement())
  storeId       String
  username      String
  credentials   String
  metadata      Json       @default("{}")
  accountNumber String?
  merchant      Merchant[] // One-to-many relationship with Merchant
}

model SwichMerchant {
  id           Int        @id @default(autoincrement())
  clientId     String     
  clientSecret String?
  merchant     Merchant[] // One-to-many relationship with Merchant
}